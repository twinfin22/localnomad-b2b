# PII 데이터 흐름도 + 컴플라이언스 체크리스트

> **목적**: PII(개인식별정보)가 시스템 내에서 어디를 거치는지 추적하고, 노출 구간이 없음을 증명합니다.
> **대상 PII**: 여권번호(passportNumber), 외국인등록번호(arcNumber)
> **관련 법규**: 개인정보보호법(PIPA), IEQAS 인증 기준
> **마지막 업데이트**: W2 D7 완료 시점

---

## 1. PII 필드 목록

| 필드 | DB 컬럼 | 암호화 | 어디서 입력 | 어디서 복호화 | 외부 전송 |
|------|---------|--------|------------|-------------|-----------|
| 여권번호 | Student.passportNumber | ✅ AES-256-GCM | 학생 등록폼, 엑셀 임포트 | 학생 상세(ADMIN/MANAGER), FIMS 내보내기 | ❌ 절대 안 함 |
| 외국인등록번호 | Student.arcNumber | ✅ AES-256-GCM | 학생 등록폼, 엑셀 임포트 | 학생 상세(ADMIN/MANAGER), FIMS 내보내기 | ❌ 절대 안 함 |
| 전화번호 | Student.phone | ❌ 평문 | 학생 등록폼, 엑셀 임포트 | (암호화 안 됨) | ❌ |
| 이메일 | Student.email | ❌ 평문 | 학생 등록폼, 엑셀 임포트 | (암호화 안 됨) | ❌ |

> **각주: AES-256-GCM이란?**
> 군사급 암호화 알고리즘. 원본 데이터를 알아볼 수 없는 문자열로 변환하고, 열쇠(key)가 있어야만 원본으로 복원 가능. GCM 모드는 "누군가 몰래 수정했는지"도 감지하는 무결성 검증 기능 포함.

---

## 2. PII 전체 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        PII 입력 경로 (2가지)                             │
│                                                                          │
│  경로 A: 학생 등록/수정 폼                경로 B: 엑셀 임포트             │
│  ┌──────────────────────┐                ┌──────────────────────┐       │
│  │ 담당자가 여권번호 입력 │                │ 엑셀 파일에 여권번호   │       │
│  │ (브라우저 폼)         │                │ 포함되어 업로드       │       │
│  └──────────┬───────────┘                └──────────┬───────────┘       │
│             │                                       │                    │
│             ▼                                       ▼                    │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │                    서버 (API Route)                           │       │
│  │                                                               │       │
│  │  1. 요청 수신                                                 │       │
│  │  2. 인증 확인 (JWT 토큰)                                      │       │
│  │  3. RBAC 확인 (ADMIN 또는 MANAGER만 가능)                     │       │
│  │  4. ⭐ encrypt(passportNumber) 호출                           │       │
│  │     원본: "M12345678"                                         │       │
│  │     → 암호화: "a1b2c3...:d4e5f6...:g7h8i9..."               │       │
│  │  5. 암호화된 값만 DB에 저장                                    │       │
│  │  6. AuditLog 생성 (누가, 언제, 무엇을 생성/수정했는지)         │       │
│  └──────────────────────────────┬───────────────────────────────┘       │
│                                 │                                        │
│                                 ▼                                        │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │                    PostgreSQL DB                              │       │
│  │                                                               │       │
│  │  Student 테이블:                                              │       │
│  │  passportNumber = "a1b2c3...:d4e5f6...:g7h8i9..."  (암호화) │       │
│  │  arcNumber = "x1y2z3...:a4b5c6...:d7e8f9..."      (암호화) │       │
│  │                                                               │       │
│  │  ⚠️ DB를 직접 열어봐도 원본 여권번호를 알 수 없음             │       │
│  └──────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                        PII 복호화 경로 (3가지)                           │
│                                                                          │
│  경로 1: 학생 상세 페이지       경로 2: FIMS 내보내기    경로 3: 챗봇    │
│  (담당자가 열람)                (엑셀 다운로드)          (학생이 입력)    │
│                                                                          │
│  ┌────────────────────┐  ┌────────────────────┐  ┌──────────────────┐  │
│  │ GET /api/students/ │  │ POST /api/fims/    │  │ POST /api/chat   │  │
│  │ [id]               │  │ export             │  │                  │  │
│  └────────┬───────────┘  └────────┬───────────┘  └────────┬─────────┘  │
│           │                       │                        │             │
│           ▼                       ▼                        ▼             │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────────┐    │
│  │ RBAC 확인    │       │ RBAC 확인    │       │ PII 마스킹       │    │
│  │              │       │              │       │                  │    │
│  │ ADMIN/MGR:   │       │ ADMIN/MGR만  │       │ maskPii() 호출   │    │
│  │  decrypt()   │       │  decrypt()   │       │ "M12345678"      │    │
│  │  → 원본 표시 │       │  → 엑셀에    │       │  → [PASSPORT_1]  │    │
│  │              │       │    원본 삽입  │       │                  │    │
│  │ VIEWER:      │       │              │       │ ⭐ Claude API에   │    │
│  │  decrypt()   │       │              │       │ [PASSPORT_1]만   │    │
│  │  → 마스킹    │       │              │       │ 전송. 절대로     │    │
│  │  "M1***5678" │       │              │       │ 원본 안 보냄     │    │
│  └──────┬───────┘       └──────┬───────┘       └──────┬───────────┘    │
│         │                      │                       │                │
│         ▼                      ▼                       ▼                │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────────┐    │
│  │ AuditLog     │       │ AuditLog     │       │ AuditLog 없음    │    │
│  │ 생성         │       │ 생성         │       │ (학생은 비인증)  │    │
│  │ action: READ │       │ action:EXPORT│       │                  │    │
│  │ resource:    │       │ resource:    │       │                  │    │
│  │ STUDENT_PII  │       │ FIMS_REPORT  │       │                  │    │
│  └──────────────┘       └──────────────┘       └──────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. PII가 절대 가지 않는 곳 (금지 경로)

```
여권번호/외국인등록번호가 절대 도달해서는 안 되는 곳:

  ❌ Claude API (Anthropic 서버)
     → maskPii()가 플레이스홀더로 치환 후 전송

  ❌ console.log / 에러 메시지
     → 코드 내에서 PII를 로그에 찍지 않음

  ❌ API 응답 (목록 조회)
     → GET /api/students 는 PII 필드 자체를 응답에서 제외

  ❌ URL 파라미터
     → 여권번호가 ?passport=M12345678 형태로 URL에 노출되지 않음

  ❌ 브라우저 localStorage / Cookie
     → PII는 서버에서만 복호화, 브라우저에 암호화 키 없음
```

---

## 4. 컴플라이언스 체크리스트

### Phase 1 (W0-W2) — 기본 보호 ✅ 완료

- [x] passportNumber, arcNumber에 AES-256-GCM 암호화 적용
- [x] AuditLog 스키마 설계 및 구현
- [x] PII 복호화 시 AuditLog 자동 생성
- [x] console.log에 PII 출력하지 않음
- [x] API 목록 응답에서 PII 필드 제외
- [x] RBAC으로 PII 접근 권한 제한 (VIEWER는 마스킹)
- [x] Claude API 호출 전 maskPii() 적용
- [x] soft delete만 사용 (hard delete 없음)

### Phase 2 (W2-W4) — 감사 추적 강화

- [x] PII 접근한 사용자/시간/사유를 AuditLog에 기록
- [ ] FIMS 내보내기 시 AuditLog에 "내보낸 학생 수, 포함된 PII 필드" 기록
- [ ] PII 복호화 API에 요청 빈도 제한(rate limit) 적용
- [ ] 비정상 PII 접근 패턴 감지 (1시간에 100건 이상 복호화 → 경고)

### Phase 3 (W4-W6) — 규제 준비

- [ ] OWASP Top 10 기본 보안 체크리스트 통과
- [ ] 위탁계약 7대 필수 조항 시스템 구현 대응표 작성
- [ ] 개인정보 처리방침 문서 초안 (파일럿 대학 제공용)
- [ ] IEQAS 인증 심사 대비 — 데이터 흐름도 제출 준비
- [ ] 데이터 국내 보관 증빙 (서버 위치: 서울 리전)

---

## 5. 암호화 키 관리

```
현재 구조:

  .env 파일
  └── AES_ENCRYPTION_KEY = "32바이트 키 문자열"
       │
       ▼
  src/lib/crypto.ts
  └── encrypt(plainText) → "iv:tag:encrypted"
  └── decrypt(cipherText) → "원본 텍스트"

⚠️ 주의사항:
  - .env 파일은 Git에 커밋하지 않음 (.gitignore에 포함)
  - 배포 환경에서는 환경 변수로 주입 (Vercel Secrets 또는 AWS Parameter Store)
  - 키가 유출되면 모든 PII가 복호화 가능 → 키 로테이션 계획 필요 (Phase 2)
```

> **각주: 키 로테이션이란?**
> 암호화 열쇠를 주기적으로 교체하는 것. 오래된 열쇠로 암호화된 데이터를 새 열쇠로 재암호화. 열쇠가 유출되었을 때 피해 범위를 제한하기 위한 보안 관행.

---

## 변경 이력

| 날짜 | 변경 내용 |
|------|-----------|
| W2 D7 | 초기 작성 |
