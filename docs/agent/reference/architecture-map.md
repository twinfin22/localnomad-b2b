# Architecture Map (시스템 구조도)

> **목적**: 시스템의 전체 구조와 데이터 흐름을 시각적으로 정리합니다. Gen의 멘탈 모델 동기화용.
> **규칙**: 주간 리뷰 시 Cowork이 업데이트. 새 기능 추가 시 해당 흐름을 추가.
> **마지막 업데이트**: W2 D7 완료 시점

---

## 1. 전체 시스템 구조 (Big Picture)

```
┌─────────────────────────────────────────────────────────────────────┐
│                        사용자 (브라우저)                              │
│                                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ 대시보드  │  │ 학생관리  │  │ 캘린더   │  │ FIMS     │            │
│  │ /        │  │ /students│  │ /calendar│  │ /fims    │            │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │
│       │              │              │              │                  │
│  ┌────┴─────┐  ┌────┴─────┐  ┌────┴─────┐  ┌────┴─────┐            │
│  │ 임포트   │  │ 알림     │  │ 설정     │  │ 챗봇위젯 │            │
│  │ /import  │  │ /alerts  │  │/settings │  │ (플로팅) │            │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │
└───────┼──────────────┼──────────────┼──────────────┼─────────────────┘
        │              │              │              │
        ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Next.js API Routes (서버)                        │
│                                                                      │
│  인증 ──── RBAC ──── universityId 필터링 ──── AuditLog              │
│   │                                                                  │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐            │
│  │Students│ │Calendar│ │Alerts  │ │Import  │ │Chat    │            │
│  │ API    │ │ API    │ │ API    │ │ API    │ │ API    │            │
│  └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘            │
│      │          │          │          │          │                   │
│  ┌───┴──────────┴──────────┴──────────┴──────┐   │                  │
│  │            Prisma ORM                      │   │                  │
│  │    encrypt/decrypt (PII)                   │   │                  │
│  └───────────────┬────────────────────────────┘   │                  │
│                  │                                │                  │
│                  ▼                                ▼                  │
│        ┌─────────────────┐              ┌─────────────────┐         │
│        │  PostgreSQL DB  │              │  Claude API     │         │
│        │  (데이터 저장)   │              │  (AI 챗봇)      │         │
│        └─────────────────┘              └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────┘
```

**핵심 보안 레이어 (모든 API 요청에 적용)**:
1. **인증(Authentication)**: "이 사람이 누구인가?" → NextAuth JWT 토큰 확인
2. **RBAC**: "이 사람이 이 작업을 할 수 있는가?" → 역할별 권한 확인
3. **universityId 필터링**: "이 사람의 대학 데이터만 보여주는가?" → 다른 대학 데이터 접근 차단
4. **AuditLog**: "누가 언제 무엇을 했는가?" → 모든 중요 작업 기록

---

## 2. 데이터베이스 구조 (ERD 간소화)

```
┌─────────────┐     ┌─────────────┐
│ University   │────<│ User        │
│ (대학)       │     │ (담당자)     │
│              │     │             │
│ id           │     │ id          │
│ name         │     │ email       │
│ overstayRate │     │ role(3종)   │
│ ieqasStatus  │     │ universityId│
└──────┬───────┘     └──────┬──────┘
       │                    │
       │    ┌───────────────┘
       │    │ (생성자)
       ▼    ▼
┌──────────────────┐
│ Student (학생)    │
│                   │
│ id                │
│ nameKr, nameEn    │
│ nationality       │
│ passportNumber 🔒 │  ← AES-256 암호화
│ arcNumber 🔒      │  ← AES-256 암호화
│ visaType (10종)   │
│ visaExpiry        │
│ visaStatus (4종)  │
│ enrollmentStatus  │  ← 이것이 바뀌면 → StatusChange + FimsReport 생성
│ attendanceRate    │
│ insuranceStatus   │
│ isDeleted         │  ← soft delete
└───┬───┬───┬───┬──┘
    │   │   │   │
    │   │   │   └──────────────────┐
    │   │   │                      ▼
    │   │   │              ┌──────────────┐
    │   │   │              │ AlertLog     │
    │   │   │              │ (알림 기록)   │
    │   │   │              │              │
    │   │   │              │ type(7종)    │
    │   │   │              │ channel(4종) │
    │   │   │              │ isRead       │
    │   │   │              └──────────────┘
    │   │   │
    │   │   └──────────────┐
    │   │                  ▼
    │   │          ┌──────────────┐
    │   │          │ FimsReport   │
    │   │          │ (FIMS 신고)   │
    │   │          │              │
    │   │          │ reportType   │  ← STATUS_CHANGE 또는 PERIODIC
    │   │          │ changeType   │  ← 휴학/제적/자퇴/졸업/미등록/소속변경
    │   │          │ deadline     │  ← 감지일 + 15일
    │   │          │ status       │  ← PENDING→READY→SUBMITTED (또는 OVERDUE)
    │   │          └──────────────┘
    │   │
    │   └──────────────────┐
    │                      ▼
    │              ┌──────────────┐
    │              │ StatusChange │
    │              │ (변경 이력)   │
    │              │              │
    │              │ field        │  ← 어떤 필드가 바뀌었는가
    │              │ oldValue     │
    │              │ newValue     │
    │              └──────────────┘
    │
    │  (독립)
    │
┌───┴──────────────┐     ┌──────────────┐
│ ImportJob        │────<│ ImportError   │
│ (임포트 작업)     │     │ (임포트 에러) │
└──────────────────┘     └──────────────┘

┌──────────────────┐     ┌──────────────┐
│ ChatSession      │────<│ ChatMessage   │
│ (채팅 세션)       │     │ (채팅 메시지) │
│                   │     │              │
│ language          │     │ role         │  ← user / assistant / staff
│ isEscalated       │     │ intent       │
│ resolvedAt        │     │ confidence   │
└──────────────────┘     │ isEscalated  │
                         │ sources(JSON)│
                         └──────────────┘

┌──────────────────┐
│ AuditLog         │  ← 모든 중요 작업의 기록
│ (감사 로그)       │
│                   │
│ action(6종)      │  ← CREATE/READ/UPDATE/DELETE/EXPORT/LOGIN
│ resource         │
│ details(JSON)    │
└──────────────────┘
```

**🔒 표시 = 암호화 저장 필드**: passportNumber, arcNumber만 해당. 이 두 필드는 DB에 평문으로 저장되지 않음.

---

## 3. 주요 데이터 흐름 (시퀀스 다이어그램)

### 흐름 A: 학생 목록 조회 (가장 기본적인 흐름)

```
담당자(브라우저)          Zustand Store           API(/api/students)        DB(PostgreSQL)
    │                        │                        │                        │
    │── 페이지 접속 ────────>│                        │                        │
    │                        │── GET /api/students ──>│                        │
    │                        │   ?page=1&limit=20     │── SELECT students ───>│
    │                        │                        │   WHERE universityId   │
    │                        │                        │   AND isDeleted=false  │
    │                        │                        │<── 학생 데이터 ────────│
    │                        │                        │                        │
    │                        │                        │── 각 학생별 TL 계산 ──│
    │                        │                        │   (서버 메모리에서)     │
    │                        │                        │                        │
    │                        │<── { students, meta } ─│                        │
    │<── UI 렌더링 ──────────│                        │                        │
    │   (테이블 + TL 색상)   │                        │                        │
```

> **각주: Zustand Store란?**
> 브라우저 내에서 데이터를 임시 보관하는 "메모리 저장소". API에서 받아온 데이터를 여기에 저장해두면, 페이지 내에서 여러 컴포넌트가 같은 데이터를 공유할 수 있음. 페이지를 새로고침하면 사라짐.

### 흐름 B: 학생 정보 수정 → 변동 감지

```
담당자(브라우저)          API(/api/students/[id])     DB                  Alert Engine
    │                        │                        │                        │
    │── PUT (수정 요청) ────>│                        │                        │
    │   enrollmentStatus:    │── 기존 학생 조회 ─────>│                        │
    │   ENROLLED→ON_LEAVE    │<── 현재 데이터 ────────│                        │
    │                        │                        │                        │
    │                        │── 변경 감지 ───────────│                        │
    │                        │   old: ENROLLED        │                        │
    │                        │   new: ON_LEAVE        │                        │
    │                        │                        │                        │
    │                        │── 트랜잭션 시작 ──────>│                        │
    │                        │   1. Student UPDATE    │                        │
    │                        │   2. StatusChange 생성 │                        │
    │                        │   3. AuditLog 생성     │                        │
    │                        │── 트랜잭션 완료 ──────>│                        │
    │                        │                        │                        │
    │<── 수정 완료 응답 ─────│                        │                        │
```

> **각주: 트랜잭션(Transaction)이란?**
> "여러 DB 작업을 하나의 묶음으로 실행"하는 것. 1번(학생 수정), 2번(변경 이력), 3번(감사 로그) 중 하나라도 실패하면 전부 취소됨(롤백). "전부 성공 아니면 전부 취소" — 데이터 일관성을 보장.

### 흐름 C: 엑셀 임포트 (4단계)

```
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 파일 업로드                                              │
│                                                                  │
│  파일(.xlsx) ──→ POST /api/import/parse                         │
│                  SheetJS가 파일을 읽음                            │
│                  ──→ { headers, rows, preview(5행) } 반환        │
└──────────────────────────────┬──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 컬럼 매핑                                                │
│                                                                  │
│  headers ──→ autoMapColumns() 패턴 사전으로 자동 매핑            │
│              "여권번호" → passportNumber (신뢰도: 높음)           │
│              "이름" → nameKr (신뢰도: 높음)                       │
│              "Grade" → ??? (신뢰도: 낮음 → 수동 매핑 필요)       │
│                                                                  │
│  담당자가 확인 + 필요 시 수동 수정 → [확인] 클릭                   │
└──────────────────────────────┬──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 유효성 검사                                              │
│                                                                  │
│  매핑된 데이터 ──→ POST /api/import/validate                    │
│                                                                  │
│  각 행(row)마다:                                                 │
│    1. 필수 필드 확인 (이름, 국적, 비자, 만료일...)                │
│    2. 형식 검사 (날짜 형식, 비자코드 형식...)                     │
│    3. 중복 검사 (여권번호 → ARC → 이름+국적 순)                   │
│       ⚠️ 여권번호 중복 검사 시 기존 학생 전체 복호화 필요         │
│                                                                  │
│  결과: ✅ 유효(120명) | ❌ 에러(5명) | ⚠️ 중복(8명)             │
│  담당자가 중복 처리 방법 선택: [건너뛰기] [덮어쓰기] [수동]       │
└──────────────────────────────┬──────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 실행                                                     │
│                                                                  │
│  POST /api/import/execute                                       │
│    유효 행 → Student CREATE (PII 암호화)                         │
│    중복(덮어쓰기) → Student UPDATE                               │
│    중복(건너뛰기) → SKIP                                         │
│    AuditLog 생성 (임포트 기록)                                   │
│                                                                  │
│  결과: 생성 120명 | 업데이트 6명 | 건너뛰기 2명 | 실패 0명       │
└─────────────────────────────────────────────────────────────────┘
```

### 흐름 D: 챗봇 메시지 처리 (PII 보안 핵심)

```
학생(챗봇 위젯)          POST /api/chat            PII Masker         Claude API
    │                        │                        │                    │
    │── "내 여권번호         │                        │                    │
    │   M12345678 로         │                        │                    │
    │   비자 연장 되나요?"──>│                        │                    │
    │                        │── maskPii() ──────────>│                    │
    │                        │                        │── 변환:            │
    │                        │                        │   "M12345678"      │
    │                        │                        │    → [PASSPORT_1]  │
    │                        │<── masked 텍스트 ──────│                    │
    │                        │   "내 여권번호          │                    │
    │                        │   [PASSPORT_1] 로       │                    │
    │                        │   비자 연장 되나요?"    │                    │
    │                        │                        │                    │
    │                        │── ⭐ masked만 전송 ──────────────────────>│
    │                        │   Claude는 실제 여권번호를                 │
    │                        │   절대 볼 수 없음                          │
    │                        │<── AI 응답 ──────────────────────────────│
    │                        │   "[PASSPORT_1] 비자는                     │
    │                        │    연장 가능합니다..."                      │
    │                        │                        │                    │
    │                        │── unmaskPii() ─────────>│                    │
    │                        │<── 복원된 응답 ─────────│                    │
    │                        │   "M12345678 비자는      │                    │
    │<── 최종 응답 ──────────│    연장 가능합니다..."   │                    │
```

**⭐ 핵심 보안 포인트**: Claude API에 전송되는 텍스트에는 `[PASSPORT_1]`, `[PHONE_1]` 같은 플레이스홀더만 포함. 실제 여권번호, 전화번호, 이메일 등은 서버 메모리에만 존재하고 절대 외부로 나가지 않음.

### 흐름 E: 알림 생성 엔진

```
담당자 [알림 생성] 클릭     POST /api/alerts/generate      DB
    │                            │                          │
    │── 클릭 ──────────────────>│                          │
    │                            │── 전체 학생 조회 ──────>│
    │                            │<── 학생 목록 ───────────│
    │                            │                          │
    │                            │── 각 학생별 4개 규칙 평가:
    │                            │                          │
    │                            │   규칙 1: 비자 만료      │
    │                            │   만료 30일 이내? → 🔴   │
    │                            │   만료 60일 이내? → 🟡   │
    │                            │                          │
    │                            │   규칙 2: 출석률         │
    │                            │   70% 미만? → 🟡         │
    │                            │                          │
    │                            │   규칙 3: FIMS 기한      │
    │                            │   7일 이내? → 🟡         │
    │                            │                          │
    │                            │   규칙 4: 보험 만료      │
    │                            │   만료/만료 임박? → 🟡   │
    │                            │                          │
    │                            │── 중복 확인 ───────────>│
    │                            │   (같은 유형 7일 이내     │
    │                            │    이미 생성했으면 스킵)  │
    │                            │                          │
    │                            │── AlertLog 생성 ───────>│
    │                            │                          │
    │<── { 생성: 15, 스킵: 8 } ─│                          │
```

---

## 4. 페이지별 실행 순서

> 각 페이지에 접속하면 브라우저에서 무슨 일이 일어나는지

### 대시보드 (/)

```
1. [서버] 페이지 렌더링 (서버 컴포넌트 — HTML 생성)
2. [브라우저] HTML 표시 (뼈대만 보임, 데이터는 아직 없음)
3. [브라우저] useEffect 실행 → 3개 API 동시 호출:
   ├── GET /api/dashboard/summary → 통계 카드 (학생 수, TL 분포, 이탈률)
   ├── GET /api/alerts?limit=10&isRead=false → 최근 알림
   └── GET /api/calendar?month=current → 이번 달 만료 현황
4. [브라우저] 데이터 도착하면 각 카드/차트 렌더링
5. [브라우저] alert-store 30초 폴링 시작 → 새 알림 배지 업데이트
```

> **각주: useEffect란?**
> React에서 "페이지가 화면에 표시된 후 실행할 코드"를 지정하는 방법. 예: "페이지 로드 후 API를 호출해서 데이터를 가져와라". 페이지의 뼈대(HTML)를 먼저 보여주고, 데이터는 나중에 채우는 패턴.

> **각주: 폴링(Polling)이란?**
> "일정 간격으로 서버에 반복 질문"하는 것. 30초 폴링 = 30초마다 "새 알림 있어?" 하고 확인. 실시간은 아니지만 단순하고 안정적. 반대는 WebSocket(서버가 먼저 알려줌) — 더 복잡.

### 학생 목록 (/students)

```
1. [서버] 페이지 렌더링
2. [브라우저] useEffect → student-store.fetchStudents()
   └── GET /api/students?page=1&limit=20
3. [브라우저] 데이터 도착 → StudentTable 렌더링 (TanStack Table)
4. [브라우저] 사용자가 필터 변경 → store.setFilter() → 자동으로 fetchStudents() 재호출
5. [브라우저] 사용자가 페이지 변경 → store.setPage() → fetchStudents() 재호출
6. [브라우저] 행 클릭 → /students/[id] 로 이동
```

### 임포트 (/import)

```
1. [브라우저] Step 1 화면 표시 (파일 업로드 영역)
2. 사용자가 파일 드래그 → POST /api/import/parse
3. [브라우저] Step 2로 전환 → 컬럼 매핑 UI
4. 사용자가 [확인] → POST /api/import/validate
5. [브라우저] Step 3로 전환 → 유효/에러/중복 탭
6. 사용자가 중복 처리 선택 → [실행] → POST /api/import/execute
7. [브라우저] Step 4로 전환 → 결과 요약
```

---

## 5. 파일 수 현황 (Day 7 완료 시점)

| 카테고리 | 수량 | 위치 |
|----------|------|------|
| 페이지 | 10 | src/app/(auth)/ + (dashboard)/ |
| API 라우트 | 16 | src/app/api/ |
| 컴포넌트 | 42 | src/components/ |
| Lib 모듈 | 17 | src/lib/ (chatbot/ 4개 포함) |
| Zustand Store | 5 | src/store/ |
| 타입 정의 | 1 (큰 파일) | src/types/index.ts |
| Prisma 모델 | 11 | prisma/schema.prisma |
| Enum | 12 | prisma/schema.prisma |
| 테스트 | 43 cases | src/lib/__tests__/ + e2e/ |
| **합계** | **~100+ 파일** | |

---

## 6. RBAC 권한 매트릭스

```
                    ADMIN    MANAGER    VIEWER
학생 조회 (read)      ✅        ✅        ✅
학생 생성 (create)    ✅        ✅        ❌
학생 수정 (update)    ✅        ✅        ❌
학생 삭제 (delete)    ✅        ❌        ❌
PII 열람 (전체)       ✅        ✅        ❌ (마스킹됨)
임포트 실행           ✅        ✅        ❌
FIMS 내보내기         ✅        ✅        ❌
알림 생성             ✅        ✅        ❌
챗봇 답변 (staff)     ✅        ✅        ❌
설정 변경             ✅        ❌        ❌
```

> **각주: RBAC (Role-Based Access Control)이란?**
> "역할에 따라 할 수 있는 것을 제한"하는 보안 모델. 마치 회사에서 "사원은 열람만, 팀장은 수정도, 부장은 삭제도 가능"처럼. 여기서는 ADMIN(관리자), MANAGER(담당자), VIEWER(열람자) 3단계.

---

## 변경 이력

| 날짜 | 변경 내용 |
|------|-----------|
| W2 D7 | 초기 작성 (Day 1-7 전체 반영) |
